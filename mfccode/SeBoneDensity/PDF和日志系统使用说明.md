# 骨密度分析模块 - PDF报告与日志系统使用说明

## 功能概述

已为骨密度分析模块添加了两个重要功能：
1. **PDF报告生成**：自动生成包含3D截图和参数表格的PDF报告
2. **日志系统**：记录所有操作过程，便于追溯和调试

---

## 一、PDF报告生成功能

### 1. 功能说明
- 自动生成包含骨参数分析结果的PDF报告
- 报告包含两部分：
  - **3D截图**：自动从 `ScreenCapture` 文件夹查找最新的截图
  - **参数表格**：显示所有计算的骨参数及其数值

### 2. 使用方法
1. 完成骨参数计算后
2. 点击"导出PDF"按钮
3. 系统自动生成PDF报告到图像文件夹

### 3. 截图查找规则
- 优先查找：`图像文件夹\ScreenCapture\` 中最新的图片文件
- 支持格式：PNG、JPG、JPEG、BMP
- 如果没有截图，报告会保留位置但显示占位文本

### 4. 输出文件命名
- 默认文件名：`Report.pdf`
- 如果有序列名，使用：`[序列名].pdf`
- 保存位置：与原始图像相同的文件夹

### 5. 技术说明
- 当前实现基于GDI+，生成高质量图像
- 建议集成 libharu 或 PDFlib 用于真正的PDF生成
- 临时方案：先生成PNG，然后转换为PDF格式

---

## 二、日志系统

### 1. 功能说明
日志系统自动记录所有关键操作，每条日志包含：
- **时间戳**：精确到毫秒
- **日志级别**：INFO、WARNING、ERROR、DEBUG
- **操作内容**：详细的操作信息

### 2. 记录的操作类型

#### 2.1 加载文件
```
示例：2025-10-13 14:32:15.123 [INFO]    加载文件 - 文件夹: D:\Data\Patient001, 文件数量: 512
```

#### 2.2 骨密度裁切
```
示例：2025-10-13 14:35:20.456 [INFO]    骨密度裁切 - 范围: X[10-502], Y[10-502], Z[50-450]
```

#### 2.3 ROI操作
```
示例：2025-10-13 14:38:45.789 [INFO]    ROI操作 - 类型: 手动圈定, 层数: 512, 开始层: 50, 结束层: 450
```

#### 2.4 二值化操作
```
示例：2025-10-13 14:40:12.345 [INFO]    二值化操作 - 最小值: 150.00, 最大值: 3000.00
```

#### 2.5 参数计算
```
示例：2025-10-13 14:45:30.678 [INFO]    参数计算 - 计算参数: 基础参数:1, 骨厚度:1, 间隙厚度:0, ...
```

#### 2.6 输出操作
```
示例：2025-10-13 14:50:00.901 [INFO]    输出操作 - 类型: Excel, 输出路径: D:\Data\Patient001\Result.xls
示例：2025-10-13 14:51:15.234 [INFO]    输出操作 - 类型: PDF, 输出路径: D:\Data\Patient001\Report.pdf
```

### 3. 日志文件位置
- 文件名：`BoneDensity.log`
- 保存位置：与图像文件相同的文件夹
- 例如：`D:\Data\Patient001\BoneDensity.log`

### 4. 日志级别说明
- **INFO**：正常操作信息
- **WARNING**：警告信息（如：未找到截图文件）
- **ERROR**：错误信息（如：生成PDF失败）
- **DEBUG**：调试信息

### 5. 查看日志
使用任何文本编辑器打开 `.log` 文件即可查看
推荐工具：
- Notepad++
- VSCode
- Sublime Text

---

## 三、代码集成说明

### 1. 新增文件
- `SeLogger.h`：日志系统类
- `SePDFReportGenerator.h`：PDF报告生成器头文件
- `SePDFReportGenerator.cpp`：PDF报告生成器实现

### 2. 修改的文件
- `SeBoneDensityCtrlDlg.h`：添加头文件引用
- `SeBoneDensityCtrlDlg.cpp`：
  - 构造函数：初始化日志系统
  - 析构函数：关闭日志系统
  - `OnBnClickedExportExcel()`：添加Excel导出日志
  - `OnBnClickedExportPdf()`：实现PDF导出功能
  - `OnBnClickedBonePartbinary()`：添加二值化日志
  - `OnBnClickedBoneCalculate()`：添加参数计算日志
  - `OnBnClickedBoneConfirmregion()`：添加ROI操作日志

### 3. 依赖库
- GDI+（已包含在Windows SDK中）
- 标准C++库：`<chrono>`, `<fstream>`, `<mutex>`

### 4. 编译配置
确保项目链接了 `gdiplus.lib`：
```cpp
#pragma comment(lib, "gdiplus.lib")
```

---

## 四、后续优化建议

### 1. PDF生成优化
- 集成 libharu 或 PDFlib 库，生成真正的PDF文件
- 支持多页PDF（如果参数很多）
- 添加更多图表（如直方图、3D视图等）

### 2. 日志系统优化
- 添加日志级别过滤功能
- 支持日志文件按大小或日期自动滚动
- 添加日志查看器UI

### 3. 功能扩展
- 支持自定义PDF模板
- 添加报告预览功能
- 支持导出为Word格式

---

## 五、使用示例

### 示例1：完整工作流程
```
1. 加载DICOM文件 -> 自动记录日志
2. 裁切ROI区域 -> 记录裁切范围
3. 二值化处理 -> 记录阈值
4. 参数计算 -> 记录计算的参数类型
5. 导出Excel -> 记录输出路径
6. 导出PDF -> 自动查找截图，生成报告
```

### 示例2：查看日志
打开 `BoneDensity.log` 文件，可以看到：
```
2025-10-13 14:30:00.000 [INFO]    === 日志系统启动 ===
2025-10-13 14:32:15.123 [INFO]    加载文件 - 文件夹: D:\Data\Patient001, 文件数量: 512
2025-10-13 14:40:12.345 [INFO]    二值化操作 - 最小值: 150.00, 最大值: 3000.00
2025-10-13 14:45:30.678 [INFO]    参数计算 - 计算参数: ...
2025-10-13 14:50:00.901 [INFO]    输出操作 - 类型: Excel, 输出路径: ...
2025-10-13 14:51:15.234 [INFO]    输出操作 - 类型: PDF, 输出路径: ...
2025-10-13 15:00:00.000 [INFO]    === 日志系统关闭 ===
```

---

## 六、常见问题

### Q1: PDF报告中没有3D截图？
**A:** 检查 `ScreenCapture` 文件夹是否存在，以及是否有图片文件。如果没有，报告会保留位置但显示占位文本。

### Q2: 日志文件在哪里？
**A:** 与DICOM图像文件在同一文件夹，文件名为 `BoneDensity.log`。

### Q3: 如何关闭日志功能？
**A:** 注释掉代码中的 `LOG_XXX` 宏调用即可。

### Q4: PDF文件太大？
**A:** 当前实现基于高分辨率PNG，建议集成真正的PDF库来优化文件大小。

---

## 七、联系与支持

如有问题或需要进一步定制，请联系开发团队。
